# Журнал разработки проекта Telegram-бота для фитнес-тренеров

## Шаг 1: Настройка проекта и окружения (15.04.2025)

- Создана базовая структура каталогов проекта (config, data, database, handlers, keyboards, models, rag, services, utils)
- Настроен файл зависимостей `requirements.txt` с необходимыми библиотеками
- Создан файл `.env.example` для конфигурационных параметров
- Создан основной файл бота `bot.py`
- Настроен файл `.gitignore`
- Создан README.md проекта

## Шаг 2: Настройка конфигурации проекта (15.04.2025)

- Создан модуль конфигурации `config/config.py` для загрузки настроек из переменных окружения
- Настроено подключение к базе данных с использованием SQLAlchemy в `database/base.py`
- Созданы пустые инициализационные файлы для всех модулей

## Шаг 3: Создание модели базы данных (15.04.2025)

- Разработаны основные модели базы данных в `database/models.py`:
  - Модель клиента (Client) с полями: имя, возраст, пол, рост, вес, уровень активности, цель, КБЖУ
  - Модель плана питания (MealPlan) для хранения сгенерированных планов
  - Модель ограничений (Restriction) для хранения аллергий и пищевых предпочтений
- Реализованы CRUD-операции в `database/db_operations.py`:
  - Функции для создания, получения, обновления и удаления клиентов
  - Функции для работы с планами питания
  - Функции для работы с ограничениями клиентов
- Исправлены ошибки линтера и оптимизирован код

## Шаг 4: Разработка RAG-системы (15.04.2025)

- Создан модуль загрузки документов `rag/loaders.py` для работы с PDF и таблицами
- Разработан основной движок RAG-системы в `rag/engine.py` для векторного поиска
- Реализована интеграция с LangChain для обработки документов
- Настроен FAISS для эффективного поиска в векторном пространстве

## Шаг 5: Разработка бизнес-логики (15.04.2025)

- Реализован сервис расчета КБЖУ `services/nutrition.py` с использованием формулы Бенедикта
- Создан сервис генерации планов питания `services/meal_planning.py`
- Добавлены калькуляторы основного обмена веществ с учетом пола, веса, роста, возраста
- Реализованы функции для расчета потребности в нутриентах с учетом целей клиента

## Шаг 6: Разработка базовых обработчиков команд (15.04.2025)

- Созданы обработчики для команд /start, /help и /about в `handlers/start.py`
- Реализована регистрация обработчиков в `handlers/__init__.py`
- Добавлены приветственные сообщения и базовая помощь пользователю

## Шаг 7: Настройка виртуального окружения и запуск бота (15.04.2025)

- Создано виртуальное окружение с Python 3.11 (`venv_py311`)
- Создан файл с минимальными зависимостями `requirements_minimal.txt`
- Установлены необходимые пакеты для базовой работы бота
- Настроен файл `.env` с переменными окружения
- Бот успешно запущен и протестированы базовые команды
- Решены проблемы с зависимостями (добавлена библиотека greenlet)

- Реализована система загрузки и обработки PDF-документов в `rag/loaders.py`:
  - Создан класс DocumentLoader для работы с документами
  - Добавлена функция разделения текста на чанки для индексации
- Разработан основной движок RAG-системы в `rag/engine.py`:
  - Создан класс RAGEngine для работы с векторным поиском
  - Реализована интеграция с FAISS для эффективного поиска
  - Добавлены функции для генерации ответов с использованием OpenAI API
- Настроено взаимодействие с загруженными PDF-файлами в папке `data`

## Шаг 5: Создание сервисов бизнес-логики (15.04.2025)

- Разработан сервис расчета КБЖУ в `services/nutrition.py`:
  - Создан класс NutritionCalculator для расчета питания
  - Реализована формула Бенедикта для расчета базового метаболизма
  - Добавлены функции расчета с учетом активности и целей клиента
- Реализован сервис генерации планов питания в `services/meal_planning.py`:
  - Создан класс MealPlanGenerator для генерации планов с учетом КБЖУ
  - Реализована интеграция с RAG-системой и OpenAI для создания персонализированных планов
  - Добавлена поддержка учета ограничений и предпочтений клиента
- Создан тест `Test/test_nutrition.py` для проверки работы калькулятора питания

## Шаг 6: Оптимизация работы с базой данных (16.04.2025)

- Улучшена работа с асинхронными сессиями базы данных:
  - Создан класс AsyncSessionContextManager в `database/base.py` для корректной работы с сессиями
  - Обновлен механизм получения сессий через контекстный менеджер
  - Исправлены ошибки с асинхронным контекстом при добавлении клиентов
- Переименован файл `db_operations.py` в `db_handlers.py` для лучшего отражения его роли
- Оптимизированы CRUD операции для работы с клиентами:
  - Добавлена поддержка асинхронных транзакций
  - Улучшена обработка ошибок при работе с базой данных
  - Добавлено логирование критических операций
- Исправлены проблемы с линтингом в обработчиках клиентов

## Шаг 7: Реализация машины состояний FSM (15.04.2025)

- Реализованы группы состояний в `models/states.py` для различных диалогов:
  - `ClientAddingStates`: состояния для процесса добавления клиента
  - `ClientEditingStates`: состояния для процесса редактирования клиента
  - `MealPlanStates`: состояния для процесса создания плана питания
- Создан универсальный обработчик отмены в `handlers/cancel.py`:
  - Единая точка обработки кнопки "Отмена" для всех FSM-диалогов
  - Улучшенная обработка состояний с очисткой контекста
- Доработаны обработчики для работы с состояниями:
  - Интегрирована машина состояний в процесс добавления клиента
  - Реализован процесс создания плана питания с сохранением промежуточных данных
  - Добавлена возможность отмены любого процесса из любого состояния
- Реорганизованы обработчики команд для приоритизации универсальных действий
- Исправлены проблемы с линтингом во всех модулях с FSM

## Шаг 8: Интеграция с OpenAI (15.04.2025)

- Создан сервис для работы с OpenAI GPT-4.1 nano в `services/ai_service.py`:
  - Реализован класс AIService для взаимодействия с API OpenAI
  - Добавлены методы для генерации планов питания
  - Реализована интеграция с RAG-системой для контекстных ответов
- Оптимизирована работа RAG-системы для лучшей производительности:
  - Улучшен загрузчик документов в `rag/loaders.py`
  - Оптимизировано разделение документов на чанки
  - Настроена более эффективная вектроризация текста
- Добавлены промпты в `.env` файл для генерации ответов и планов питания:
  - Настроен промпт для создания планов питания с учетом КБЖУ и ограничений
  - Добавлен промпт для RAG-системы с сохранением контекста
  - Реализована поддержка HTML-форматирования для улучшения читаемости ответов
- Создан тестовый модуль `Test/test_rag_openai.py` для проверки интеграции
- Исправлены проблемы с линтингом в новых модулях

## Шаг 9: Упрощение и оптимизация RAG-системы (15.04.2025)

- Создан упрощенный сервис для работы с OpenAI в `services/openai_simple.py`:
  - Удалены устаревшие импорты
  - Оптимизирована инициализация клиента OpenAI
  - Улучшена обработка ошибок
- Разработана упрощенная RAG-система в `rag/simple_rag.py`:
  - Реализована прямая работа с PDF-файлами из папки `data`
  - Оптимизировано создание и сохранение эмбеддингов
  - Улучшен поиск релевантной информации
- Создан интегрированный сервис в `services/fitness_bot_service.py`:
  - Объединены функции RAG и OpenAI
  - Реализован расчет КБЖУ по формуле Бенедикта
  - Добавлена генерация планов питания с учетом ограничений
- Созданы тесты для новых компонентов:
  - `Test/test_simple_rag.py` для проверки упрощенной RAG-системы
  - `Test/test_fitness_bot_service.py` для проверки интегрированного сервиса
- Обновлена документация проекта:
  - Актуализирована архитектура в `ARCHITECTURE.md`
  - Дополнен журнал разработки в `JOURNAL.md`
